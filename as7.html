<html>

<head>

<link rel="stylesheet" type="text/css" href="CSS\img.css">

<script>

	var IMAGE_PATH = "resources/boardImages/";
	var NUMBER_OF_CARDS = 8;
	var ROWS = 4;
	var COLS = 4;
	var stillAnimating = false;
	var score = 10000;
	var start = false;
	
	var images = new Array(NUMBER_OF_CARDS*2);

	function initialize(){
		
		// read in images into an array
		for(var i = 0; i < NUMBER_OF_CARDS*2; i++){
			var image = new Image();
			image.id = "img" + i;
			image.src = IMAGE_PATH + (i%8) + ".jpg";
			images[i] = image;
		}
	
		// shuffle the array of images
		var currentIndex = images.length;
		while (0 !== currentIndex) {
			var randomIndex = Math.floor(Math.random() * currentIndex);
			currentIndex -= 1;
			var temp = images[currentIndex];
			images[currentIndex] = images[randomIndex];
			images[randomIndex] = temp;
		}
		
		// deal the cards
		// TODO animate the dealing process
		var html = "";
		for(var i = 0; i < ROWS; i++){
			html += "<tr>";
			for(var j = 0; j < COLS; j++){
				html += "<td onclick='imageClicked(this);' class='border'><div id='div" + ((i*COLS)+j);
				html += "'><img id='" + i + j + "' src='" + images[(i*COLS)+j].src;
				html += "' height='100' width='100' draggable='false'></div></td>";
			}
			html += "</tr>"
		}
		document.getElementById("board").innerHTML = html;
		
		for (var i = 0; i < ROWS; i++) {
			for (var j = 0; j < COLS; j++) {
				var div = document.getElementById("div" + ((i*COLS)+j));
				div.className = "transparent";
			}
		}
	}
	
	// TODO animate the image flipping
	// TODO flip the images if they do not match
	function imageClicked(td){
		if(start == false){
			startTimer();
		}
		
		if (!stillAnimating) {
			div = td.childNodes[0];
			// search if an image is selected
			if(div.childNodes[0].isMatched){
				alert("This image has already been matched with another. Please select another image.");
				return;
			}
			
			var image = 0;
			for(var i = 0; i < ROWS; i++){
				for(var j = 0; j < COLS; j++){
					if(document.getElementById("" + i + j).isSelected){
						image = document.getElementById("" + i + j);
					}
				}
			}
			
			if(image != 0){
				var child = div.childNodes;
				if (image.src === child[0].src && image.id !== child[0].id) {
					div.className = "visible";
					matched(div, image);
				}
				else if (image.id === child[0].id) {
					alert("You already selected this image.");
				}
				else {
					div.className = "visible";
					notMatched(div, image, 1);
				}
			}
			else{
				div.className = "visible";
				var anImage = document.getElementById("" + div.childNodes[0].id);
				anImage.isSelected = true;
			}
		}
	}
	
	function matched(div, image){
		// deselect
		div.childNodes[0].isSelected = false;
		image.isSelected = false;
		
		// mark matched
		div.childNodes[0].isMatched = true;
		image.isMatched = true;
	}
	
	function notMatched(div, image, count){
		stillAnimating = true;
		if (count === 0) {
			// deselect
			div.childNodes[0].isSelected = false;
			image.isSelected = false;
		
			// make transparent
			div.className = "transparent";
			image.parentNode.className = "transparent";
			setStillAnimating(false, 1);
			
			score -= 50;
		}
		else {
			count--;
			setTimeout(function(){notMatched(div, image, count)}, 1000);
		}
	}
	
	function setStillAnimating(animating, count) {
		if (count === 0) {
			stillAnimating = animating
		}
		else {
			count--;
			setTimeout(function(){setStillAnimating(false, count)}, 1000);
		}
	}
	
	function startTimer(){
		start = true;
		setInterval(function(){ 
			score--;
			document.getElementById("scoreboard").innerHTML = "Score: " + score;
		}, 1000);
	}

</script>

</head>

<body onload="initialize();">

<center><a href="Description.html">DESCRIPTION</a></center>

<br><br><p id = "scoreboard" align = "center"></p><br>

<table id="board" align="center">
</table>

</body>

</html>
